<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bored Api</title>
    <link rel="stylesheet" href="diagnostico.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <h1>Bored API - Encuentra tu próxima actividad</h1>
    <p>Obtén actividades aleatorias o filtra por categoría</p>
    
    <div class="controls-container">
        <div class="category-selector">
            <label for="activityType">Categoría:</label>
            <select id="activityType">
                <option value="">Cualquier actividad</option>
                <option value="education">Educación</option>
                <option value="recreational">Recreativa</option>
                <option value="social">Social</option>
                <option value="charity">Caridad</option>
                <option value="cooking">Cocina</option>
                <option value="relaxation">Relajación</option>
                <option value="busywork">Trabajo</option>
            </select>
        </div>
        
        <div class="button-container">
            <button id="newActivityBtn">Obtener actividad</button>
        </div>
    </div>
    
    <div id="response">Selecciona una categoría y presiona "Obtener actividad"</div>

</body>

<script>
    // Lista de proxies CORS públicos para probar
    const corsProxies = [
        'https://api.allorigins.win/raw?url=',
        'https://cors-anywhere.herokuapp.com/',
        'https://api.codetabs.com/v1/proxy?quest=',
        'https://thingproxy.freeboard.io/fetch/'
    ];

    // Guardar última clave para evitar mostrar repetidos en peticiones aleatorias
    let lastKey = null;

    document.getElementById('newActivityBtn').addEventListener('click', () => {
        const btn = document.getElementById('newActivityBtn');
        btn.disabled = true;
        btn.textContent = 'Buscando...';
        fetchWithProxy();
    });

    function resetButton() {
        const btn = document.getElementById('newActivityBtn');
        btn.disabled = false;
        btn.textContent = 'Obtener actividad';
    }

    async function fetchWithProxy() {
        const activityType = document.getElementById('activityType').value;
        let targetUrl;
        
        // Añadir cache-buster para evitar respuestas cacheadas por proxies públicos
        const ts = Date.now();
        if (activityType) {
            // Cuando se filtra por tipo usamos el endpoint /filter del mirror (devuelve array)
            targetUrl = `https://bored-api.appbrewery.com/filter?type=${activityType}&_=${ts}`;
        } else {
            // Para aleatorio preferimos la API oficial (más estable)
            targetUrl = `https://www.boredapi.com/api/activity?_=${ts}`;
        }
        
    document.getElementById('response').textContent = 'Obteniendo actividad...';
        
        // Primero intentar sin proxy (con reintentos anti-repetición si llega la misma clave)
        try {
            const directResponse = await axios.get(targetUrl, { timeout: 3000 });
            const handled = await handleDirectResponse(directResponse.data, targetUrl);
            if (handled) return;
            // Si no se pudo manejar (por ejemplo siempre se repitió), probar proxies
            try {
                await tryProxies(targetUrl);
            } catch (e) {
                // ignorar y dejar que finally resetButton() corra
            }
        } catch (directError) {
            // Si el acceso directo falla, probar con proxies
            try {
                await tryProxies(targetUrl);
            } catch (e) {
                // Ignorar para que finalmente resetButton se ejecute
            }
        } finally {
            resetButton();
        }
    }

    // Intenta procesar la respuesta directa y evita repetir la misma actividad (por key)
    async function handleDirectResponse(data, originalUrl, attempts = 3) {
        // Extraer una actividad del resultado (si viene array)
        let activity = Array.isArray(data) ? data[Math.floor(Math.random() * data.length)] : data;

        if (activity && activity.key && lastKey && activity.key === lastKey && attempts > 0) {
            // Si es la misma clave, intentar de nuevo con un cache-buster nuevo
            const newUrl = (originalUrl.includes('_=')) ? originalUrl.replace(/_=[0-9]+/, '_=' + Date.now()) : originalUrl + (originalUrl.includes('?') ? '&' : '?') + '_=' + Date.now();
            try {
                const resp = await axios.get(newUrl, { timeout: 3000 });
                return await handleDirectResponse(resp.data, newUrl, attempts - 1);
            } catch (e) {
                return false; // no pudo reintentar
            }
        }

        // Si no es repetida, mostrar y guardar la key
        if (activity && activity.key) {
            lastKey = activity.key;
        }
        if (activity) {
            displayActivity(activity, originalUrl || 'direct');
            return true;
        }
        return false;
    }

    async function tryProxies(targetUrl) {
        for (let i = 0; i < corsProxies.length; i++) {
            try {
                const proxyUrl = corsProxies[i] + encodeURIComponent(targetUrl);
                
                const response = await axios.get(proxyUrl, { 
                    timeout: 4000,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                let data = response.data;
                
                // Algunos proxies devuelven string, otros objeto
                if (typeof data === 'string') {
                    try {
                        data = JSON.parse(data);
                    } catch (parseError) {
                        continue;
                    }
                }
                
                // Mostrar progreso del proxy probado
                document.getElementById('response').textContent = `Probando proxy ${i + 1} de ${corsProxies.length}...`;

                // Verificar que la respuesta tiene el formato esperado
                if (data && (data.activity || Array.isArray(data))) {
                    displayActivity(data, proxyUrl);
                    resetButton();
                    return;
                }
                
            } catch (proxyError) {
                // Continuar con el siguiente proxy
                continue;
            }
        }
        
        // Si todos los proxies fallan, mostrar actividades locales
        showLocalActivityByType();
        resetButton();
    }




    function getLocalActivities() {
        return {
            education: [
            { activity: "Read a book you have pending", participants: 1, price: 0, accessibility: 0.2 },
            { activity: "Learn 5 new words in another language", participants: 1, price: 0, accessibility: 0.3 },
            { activity: "Watch an educational documentary", participants: 1, price: 0, accessibility: 0.1 },
            { activity: "Practice math for 20 minutes", participants: 1, price: 0, accessibility: 0.4 }
            ],
            recreational: [
            { activity: "Go for a 30-minute walk", participants: 1, price: 0, accessibility: 0.1 },
            { activity: "Play a video game you have", participants: 1, price: 0, accessibility: 0.2 },
            { activity: "Watch a movie from your watchlist", participants: 1, price: 0, accessibility: 0.1 },
            { activity: "Listen to new music for 1 hour", participants: 1, price: 0, accessibility: 0.1 }
            ],
            social: [
            { activity: "Call a friend you haven't seen in a while", participants: 2, price: 0, accessibility: 0.4 },
            { activity: "Send a message to someone special", participants: 2, price: 0, accessibility: 0.2 },
            { activity: "Organize a family video call", participants: 3, price: 0, accessibility: 0.5 },
            { activity: "Write a handwritten letter to someone", participants: 2, price: 0.1, accessibility: 0.3 }
            ],
            charity: [
            { activity: "Donate clothes you no longer use", participants: 1, price: 0, accessibility: 0.6 },
            { activity: "Help someone with their homework", participants: 2, price: 0, accessibility: 0.4 },
            { activity: "Volunteer online", participants: 1, price: 0, accessibility: 0.5 },
            { activity: "Donate to a charitable cause", participants: 1, price: 0.5, accessibility: 0.3 }
            ],
            cooking: [
            { activity: "Learn a new cooking recipe", participants: 1, price: 0.3, accessibility: 0.3 },
            { activity: "Bake homemade cookies", participants: 1, price: 0.2, accessibility: 0.4 },
            { activity: "Make a healthy smoothie", participants: 1, price: 0.1, accessibility: 0.2 },
            { activity: "Cook something without following a recipe", participants: 1, price: 0.2, accessibility: 0.5 }
            ],
            relaxation: [
            { activity: "Meditate for 15 minutes", participants: 1, price: 0, accessibility: 0.1 },
            { activity: "Take a relaxing bath", participants: 1, price: 0.1, accessibility: 0.2 },
            { activity: "Practice basic yoga", participants: 1, price: 0, accessibility: 0.3 },
            { activity: "Write in a personal journal", participants: 1, price: 0, accessibility: 0.1 }
            ],
            busywork: [
            { activity: "Organize your work desk", participants: 1, price: 0, accessibility: 0.2 },
            { activity: "Clean and organize your room", participants: 1, price: 0, accessibility: 0.3 },
            { activity: "Update your resume", participants: 1, price: 0, accessibility: 0.4 },
            { activity: "Organize the photos on your phone", participants: 1, price: 0, accessibility: 0.2 }
            ]
        };
    }

    function showLocalActivityByType() {
        const activityType = document.getElementById('activityType').value;
        const allActivities = getLocalActivities();
        
        if (activityType && allActivities[activityType]) {
            // Si hay categoría seleccionada, mostrar todas las de esa categoría
            const selectedActivities = allActivities[activityType].map(activity => ({
                ...activity,
                type: activityType,
                key: Math.floor(Math.random() * 1000000),
                link: ""
            }));
            
            displayActivity(selectedActivities, 'local');
        } else {
            // Si no hay tipo seleccionado, mostrar una aleatoria de cualquier categoría
            const flatActivities = Object.values(allActivities).flat();
            const randomActivity = flatActivities[Math.floor(Math.random() * flatActivities.length)];
            
            // Agregar propiedades faltantes
            randomActivity.type = Object.keys(allActivities).find(key => 
                allActivities[key].includes(randomActivity)) || 'mixed';
            randomActivity.key = Math.floor(Math.random() * 1000000);
            randomActivity.link = "";
            
            displayActivity(randomActivity, 'local');
        }
        
    }

    function showLocalActivity() {
        showLocalActivityByType();
    }

    function displayActivity(activityData, source) {
        const responseElement = document.getElementById('response');
        
        // Si la API devuelve un array (filtros), mostrar todas las actividades
        if (Array.isArray(activityData)) {
            if (activityData.length === 0) {
                responseElement.textContent = '❌ No se encontraron actividades para esta categoría';
                return;
            }
            
            // Mostrar todas las actividades de la categoría
            let allActivitiesHtml = `<div class="activities-grid">`;
            allActivitiesHtml += `<h3>Todas las actividades encontradas (${activityData.length}):</h3>`;
            
            activityData.forEach((activity, index) => {
                allActivitiesHtml += `
                    <div class="activity-item">
                        <h4>Actividad ${index + 1}</h4>
                        ${renderActivityCard(activity, source)}
                    </div>
                `;
            });
            
            allActivitiesHtml += `</div>`;
            responseElement.innerHTML = allActivitiesHtml;
            
            // Mostrar primera actividad en la tabla también
            const firstActivity = activityData[0];
            updateTable(firstActivity);
            
        } else {
            // Para actividades individuales (aleatorio), mostrar solo una
            responseElement.innerHTML = renderActivityCard(activityData, source);
            updateTable(activityData);
        }
    }

    function updateTable(activity) {
        if (!activity) return;
        
        const table = document.getElementById('activityTable');
        const tableBody = document.getElementById('activityTableBody');

        if (table && tableBody) {
            table.style.display = 'table';
            tableBody.innerHTML = '';

            const row = document.createElement('tr');

            const typeCell = document.createElement('td');
            typeCell.textContent = activity.type;
            row.appendChild(typeCell);

            const activityCell = document.createElement('td');
            activityCell.textContent = activity.activity;
            row.appendChild(activityCell);

            const participantsCell = document.createElement('td');
            participantsCell.textContent = activity.participants;
            row.appendChild(participantsCell);

            const priceCell = document.createElement('td');
            priceCell.textContent = activity.price;
            row.appendChild(priceCell);

            const linkCell = document.createElement('td');
            linkCell.textContent = activity.link || 'N/A';
            row.appendChild(linkCell);

            const keyCell = document.createElement('td');
            keyCell.textContent = activity.key;
            row.appendChild(keyCell);

            const actionCell = document.createElement('td');
            const selectButton = document.createElement('button');
            selectButton.textContent = 'Seleccionar';
            selectButton.addEventListener('click', () => {
                alert('Actividad seleccionada: ' + activity.activity);
            });
            actionCell.appendChild(selectButton);
            row.appendChild(actionCell);

            tableBody.appendChild(row);
        }
    }

    // Render a readable HTML card from an activity object
    function renderActivityCard(activity, source) {
        if (!activity) return '';
        const price = (activity.price === 0 || activity.price === undefined) ? 'Gratis' : activity.price;
        const accessibility = (activity.accessibility === undefined) ? 'N/A' : activity.accessibility;
        const link = activity.link ? `<a href="${activity.link}" target="_blank">${activity.link}</a>` : 'N/A';

        return `
            <div class="activity-card">
                <div class="field"><strong>Tipo:</strong> ${activity.type || 'N/A'}</div>
                <div class="field"><strong>Actividad:</strong> ${activity.activity || 'N/A'}</div>
                <div class="field"><strong>Participantes:</strong> ${activity.participants ?? 'N/A'}</div>
                <div class="field"><strong>Accesibilidad:</strong> ${accessibility}</div>
            </div>
        `;
    }
</script>

</html>
